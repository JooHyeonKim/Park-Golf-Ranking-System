# 로그인 후 처리 개선

## Context

소셜 로그인(Google/Kakao OAuth) 후 앱이 다시 로드되면서 `screenMode` 상태가 `'mode-select'`로 초기화되어 로그인 화면이 다시 표시되는 문제. 이메일/비밀번호 로그인은 페이지 리디렉트 없이 `onLoginSuccess()`가 직접 호출되므로 정상 동작하지만, OAuth는 외부 사이트로 리디렉트 후 돌아오기 때문에 네비게이션 의도가 유실됨.

## 수정 대상 파일

| 파일 | 변경 내용 |
|------|-----------|
| `src/hooks/useAuth.js` | `authEvent` 상태 추가, `onAuthStateChange` 이벤트 타입 노출 |
| `src/components/auth/AuthLoginScreen.jsx` | OAuth 리디렉트 전 네비게이션 의도 localStorage 저장 |
| `src/App.jsx` | 로딩 화면 추가, OAuth 콜백 감지 후 의도 복원 useEffect 추가 |

## 구현 계획

### 1단계: useAuth.js - authEvent 노출

`onAuthStateChange` 콜백의 `event` 파라미터를 상태로 저장하여 외부에서 접근 가능하게 함.

- Supabase 이벤트 종류:
  - `INITIAL_SESSION` - 기존 세션 복원 (일반 페이지 로드)
  - `SIGNED_IN` - 새 로그인 (OAuth 콜백 포함)
  - `TOKEN_REFRESHED` - 토큰 갱신

변경사항:
- `authEvent` state 추가
- `onAuthStateChange` 콜백에서 `event` 저장
- return 객체에 `authEvent` 포함

### 2단계: AuthLoginScreen.jsx - 네비게이션 의도 저장

`handleOAuth()` 함수에서 `signInWithOAuth()` 호출 전에 localStorage에 의도 저장:
```javascript
localStorage.setItem('parkgolf-auth-redirect-intent', 'collab-role');
```

### 3단계: App.jsx - 핵심 라우팅 수정

**A. 로딩 화면 추가**
- `useAuthContext()`에서 `isLoading`, `authEvent` 추가 추출
- 렌더링 최상단에 `isLoading` 체크 → 로딩 스피너 표시
- OAuth 리디렉트 후 mode-select 화면이 순간적으로 보이는 문제 해결

**B. OAuth 콜백 감지 useEffect**
```javascript
useEffect(() => {
  if (authEvent === 'SIGNED_IN' && isAuthenticated) {
    const intent = localStorage.getItem('parkgolf-auth-redirect-intent');
    if (intent) {
      localStorage.removeItem('parkgolf-auth-redirect-intent');
      setScreenMode(intent);
    }
  }
}, [authEvent, isAuthenticated]);
```

**C. 의도 정리**
- `handleBackToModeSelect()`에서 localStorage 의도 삭제
- `handleLogout()`에서 localStorage 의도 삭제

## OAuth 로그인 흐름 (수정 후)

```
사용자: "협동 입력" 클릭
  → isAuthenticated === false → auth-login 화면
  → "Google로 계속하기" 클릭
  → localStorage에 'collab-role' 저장
  → Google OAuth 리디렉트
  → 인증 완료 → 앱으로 복귀

앱 재시작:
  → isLoading === true → 로딩 화면 표시
  → getSession() 완료 → isLoading = false
  → onAuthStateChange: event = 'SIGNED_IN'
  → useEffect: intent = 'collab-role' 읽기
  → localStorage 정리
  → setScreenMode('collab-role')
  → 역할 선택 화면 표시 ✓
```

## 엣지 케이스 처리

| 시나리오 | 동작 |
|----------|------|
| 일반 페이지 로드 (이미 로그인됨) | `INITIAL_SESSION` 이벤트 → useEffect 무시 → mode-select 유지 |
| OAuth 완료 후 복귀 | `SIGNED_IN` 이벤트 → intent 읽기 → collab-role 이동 |
| OAuth 시작 후 취소/뒤로가기 | intent는 localStorage에 남지만 `SIGNED_IN` 미발생 → 무시됨 |
| 토큰 갱신 | `TOKEN_REFRESHED` 이벤트 → useEffect 무시 |
| 이메일/비밀번호 로그인 | `onLoginSuccess()` 직접 호출 → 기존 흐름 유지 |

## 검증 방법

1. **OAuth 로그인 테스트**: Google/Kakao 로그인 후 collab-role 화면으로 자동 이동 확인
2. **이메일 로그인 테스트**: 기존 이메일 로그인 흐름이 변경 없이 동작 확인
3. **프로필 표시 확인**: mode-select 화면에서 로그인 상태 (초록 점 + 이름) 표시 확인
4. **로딩 화면 확인**: OAuth 리디렉트 후 mode-select가 순간적으로 보이지 않는지 확인
5. **로그아웃 테스트**: 로그아웃 후 mode-select 복귀 확인
6. `npm run build` 성공 확인

## 구현 후 plans 폴더에 복사

구현 완료 후 이 플랜을 `plans/2026-02-27-로그인후처리.md`에 저장.
