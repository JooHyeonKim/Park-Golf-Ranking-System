# 회원가입 기능 구현 계획

## Context

현재 앱은 인증 없이 device UUID로 사용자를 식별한다. 협동입력모드에서 실제 사용자 계정이 필요하며, 오프라인 기능(솔로 대회, 점수 계산, 클럽 관리)은 로그인 없이 그대로 사용 가능하게 유지한다.

## 핵심 설계 방향

- **오프라인 기능 = 로그인 불필요** (솔로 대회, 점수 입력, 랭킹, 클럽/회원 관리)
- **협동입력모드 = 로그인 필수** (대회 생성, 참여, 실시간 점수 입력)
- **인증 방식**: 이메일/비밀번호 + Google OAuth + Kakao OAuth (Supabase Auth)
- **device ID → user ID 전환**: 협동모드에서 기존 deviceId 대신 Supabase auth user ID 사용

## 화면 흐름

```
mode-select (우측 상단: 프로필 아이콘)
  ├─ 솔로: list → score → summary (로그인 불필요, 기존과 동일)
  ├─ 협동입력:
  │    ├─ 로그인 안 됨 → 'auth-login' (로그인/회원가입 화면)
  │    └─ 로그인 됨 → 'collab-role' (기존 협동 플로우)
  └─ 프로필 아이콘 클릭 → 'auth-profile' (계정 정보/로그아웃)
```

## 새로 만들 파일 (5개)

| 파일 | 설명 |
|------|------|
| `src/contexts/AuthContext.jsx` | React Context Provider (auth 상태 전역 공유) |
| `src/hooks/useAuth.js` | 인증 훅 (login, signup, OAuth, logout, session 관리) |
| `src/components/auth/AuthLoginScreen.jsx` | 로그인/회원가입 화면 (이메일 + 소셜) |
| `src/components/auth/AuthProfileScreen.jsx` | 프로필 화면 (계정 정보, 로그아웃) |
| `src/utils/identity.js` | 협동모드용 사용자 식별자 유틸리티 |

## 수정할 파일 (8개)

| 파일 | 변경 내용 |
|------|----------|
| `src/main.jsx` | `<AuthProvider>`로 `<App />` 감싸기 |
| `src/App.jsx` | `auth-login`, `auth-profile` 화면 추가, 협동모드 진입 시 인증 게이트 |
| `src/components/collab/CollabModeSelect.jsx` | 우측 상단 프로필 아이콘 추가 |
| `src/hooks/useCollabTournament.js` | `getDeviceId()` → `userId` 파라미터로 전환 |
| `src/hooks/useCollabParticipant.js` | `getDeviceId()` → `userId` 파라미터로 전환 |
| `src/components/collab/CollabGroupSelect.jsx` | `getDeviceId()` → `userId` prop |
| `src/components/collab/CollabScoreCard.jsx` | `getDeviceId()` → `userId` prop |
| `src/utils/supabaseOps.js` | `createCollabTournament`에 `leader_user_id` 추가, 매핑 업데이트 |

## 변경 불필요

- `src/hooks/useCollabVerification.js` — submissions 키를 문자열로 비교하므로 deviceId/userId 무관
- 솔로 관련 전체 (`useTournaments.js`, `ScoreTable.jsx`, `TournamentList.jsx`, `SummaryPage.jsx` 등)
- 클럽/회원 관련 전체 (`useClubs.js`, `useMembers.js`, `ClubManagement.jsx` 등)
- `src/utils/deviceId.js` — 하위 호환용으로 유지

## DB 마이그레이션 (Supabase MCP로 실행)

### 1. profiles 테이블 + 자동 생성 트리거
```sql
CREATE TABLE profiles (
  id            UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  display_name  TEXT,
  avatar_url    TEXT,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "profiles_select_all" ON profiles FOR SELECT TO authenticated, anon USING (true);
CREATE POLICY "profiles_insert_own" ON profiles FOR INSERT TO authenticated WITH CHECK (auth.uid() = id);
CREATE POLICY "profiles_update_own" ON profiles FOR UPDATE TO authenticated USING (auth.uid() = id) WITH CHECK (auth.uid() = id);

-- 회원가입 시 자동 프로필 생성
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO profiles (id, display_name, avatar_url)
  VALUES (
    NEW.id,
    COALESCE(NEW.raw_user_meta_data ->> 'display_name', NEW.raw_user_meta_data ->> 'full_name', split_part(NEW.email, '@', 1)),
    NEW.raw_user_meta_data ->> 'avatar_url'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();
```

### 2. tournaments에 leader_user_id 컬럼 추가
```sql
ALTER TABLE tournaments ADD COLUMN leader_user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL;
CREATE INDEX idx_tournaments_leader_user_id ON tournaments (leader_user_id);
```

### 3. RLS 정책 업데이트 (쓰기는 authenticated만)
```sql
DROP POLICY IF EXISTS "anon_insert_tournaments" ON tournaments;
DROP POLICY IF EXISTS "anon_update_tournaments" ON tournaments;
CREATE POLICY "auth_insert_tournaments" ON tournaments FOR INSERT TO authenticated WITH CHECK (true);
CREATE POLICY "auth_update_tournaments" ON tournaments FOR UPDATE TO authenticated USING (leader_user_id = auth.uid()) WITH CHECK (leader_user_id = auth.uid());

DROP POLICY IF EXISTS "anon_insert_groups" ON groups;
DROP POLICY IF EXISTS "anon_update_groups" ON groups;
CREATE POLICY "auth_insert_groups" ON groups FOR INSERT TO authenticated WITH CHECK (true);
CREATE POLICY "auth_update_groups" ON groups FOR UPDATE TO authenticated USING (true) WITH CHECK (true);
```

## 구현 순서

### Phase 1: Supabase 인증 설정
1. Supabase Dashboard에서 Email, Google, Kakao provider 활성화
2. Google Cloud Console에서 OAuth 2.0 클라이언트 ID 생성
3. Kakao Developers에서 앱 등록 및 REST API 키 발급
4. DB 마이그레이션 실행 (profiles 테이블, leader_user_id 컬럼, RLS 업데이트)

### Phase 2: Auth 인프라 (hooks + context)
1. `src/hooks/useAuth.js` 생성
2. `src/contexts/AuthContext.jsx` 생성
3. `src/main.jsx` 수정 (AuthProvider 래핑)

### Phase 3: Auth UI 화면
1. `src/components/auth/AuthLoginScreen.jsx` 생성 (탭: 로그인/회원가입 + 소셜)
2. `src/components/auth/AuthProfileScreen.jsx` 생성

### Phase 4: App.jsx 라우팅 통합
1. `auth-login`, `auth-profile` 화면 모드 추가
2. 협동모드 진입 시 인증 게이트 추가
3. `CollabModeSelect`에 프로필 아이콘 전달

### Phase 5: deviceId → userId 전환
1. `src/utils/identity.js` 생성
2. `useCollabTournament.js` — userId 파라미터 사용
3. `useCollabParticipant.js` — userId 파라미터 사용
4. `CollabGroupSelect.jsx`, `CollabScoreCard.jsx` — userId prop
5. `supabaseOps.js` — leader_user_id 지원 추가

### Phase 6: 빌드 & 테스트
1. `npm run build` 성공 확인
2. 솔로 모드: 로그인 없이 정상 동작 확인
3. 협동모드: 미로그인 → 로그인 화면 → 로그인 후 정상 진행
4. 이메일 회원가입/로그인, Google OAuth, Kakao OAuth 각각 테스트
5. 협동모드 전체 플로우 (대회 생성 → 참여 → 제출 → 검증) userId 기반 동작 확인
