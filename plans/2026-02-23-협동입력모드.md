# 협동입력모드 구현 플랜

## Context

현재 앱은 완전 오프라인 PWA로, 한 기기에서 모든 점수를 입력하는 방식(혼자입력모드)만 지원한다.
대회 현장에서는 여러 명이 동시에 각 조의 점수를 입력하고, 2인 교차검증을 통해 기록의 정확성을 보장해야 한다.
이를 위해 Firebase Firestore 기반의 실시간 협동입력모드를 추가한다.

---

## 1. 전체 화면 흐름

```
앱 시작
  ├── [혼자입력] → 기존 TournamentList (현재 모든 기능 그대로)
  └── [협동입력] → 역할 선택
        ├── [팀장] → 대회 생성 → 대회코드 발급 → 사전정보 등록 → 실시간 대시보드
        └── [참여자] → 코드 입력 → 대회 진입 → 조 선택 → 스코어카드 입력 → 제출/검증
```

---

## 2. Firebase 설정

### 의존성 추가
```bash
npm install firebase
```

### 새 파일: `src/utils/firebase.js`
- Firebase 초기화, Firestore 인스턴스 export
- 환경변수(`.env`)에서 config 읽기: `VITE_FIREBASE_*`

### 새 파일: `.env.example`
```
VITE_FIREBASE_API_KEY=
VITE_FIREBASE_AUTH_DOMAIN=
VITE_FIREBASE_PROJECT_ID=
VITE_FIREBASE_STORAGE_BUCKET=
VITE_FIREBASE_MESSAGING_SENDER_ID=
VITE_FIREBASE_APP_ID=
```

### Firestore 보안 규칙
- 인증 없이 코드 기반 접근 (MVP 수준)
- tournaments 컬렉션: read/create/update 허용, delete 불가

---

## 3. Firestore 데이터 모델

### `tournaments/{docId}` 문서
```js
{
  code: string,              // 6자리 영숫자 (예: "HK3N7P"), unique
  name: string,              // 대회명
  date: string,              // "YYYY-MM-DD"
  holeCount: 18 | 36,
  status: 'setup' | 'active' | 'completed',
  leaderDeviceId: string,    // 팀장 기기 UUID
  createdAt: Timestamp,

  // 홀별 파 (각 9개 정수 배열)
  parA: number[],            // [4, 3, 5, 4, 3, 4, 5, 3, 4]
  parB: number[],
  parC: number[] | null,     // 18홀이면 null
  parD: number[] | null,

  // 이 대회에 참여하는 클럽 목록
  clubs: string[],
}
```

### `tournaments/{docId}/groups/{groupNumber}` 서브컬렉션
조 구조는 기존 ScoreTable과 동일. 기본 4명, "A-1-1" 형태로 추가 가능.

```js
{
  groupNumber: number,       // 1~36
  course: string,            // "A-1", "A-2", ..., "D-9"
  players: [
    { slot: 0, name: string, gender: string, club: string, course: string },
    { slot: 1, ... },
    // ...최대 8명 (기본 4 + 추가 4)
  ],

  // 제출 데이터 (기기ID를 키로)
  submissions: {
    [deviceId: string]: {
      nickname: string,
      submittedAt: Timestamp,
      scores: {
        [slotIndex: string]: {
          A: number[],       // A1~A9 (9개 점수)
          B: number[],
          C?: number[],      // 36홀만
          D?: number[],
        }
      }
    }
  },

  // 검증 상태
  verificationStatus: 'pending' | 'verified' | 'conflict',
  verifiedScores: { ... } | null,
  discrepancies: [
    { playerSlot: number, course: string, hole: number, values: { [deviceId]: number } }
  ] | null,
}
```

---

## 4. 신규 파일 목록

### 유틸리티
| 파일 | 역할 |
|------|------|
| `src/utils/firebase.js` | Firebase 초기화 |
| `src/utils/firestoreOps.js` | Firestore CRUD 전체 (대회/조/제출) |
| `src/utils/tournamentCode.js` | 6자리 코드 생성 (I,O,0,1 제외) |
| `src/utils/deviceId.js` | localStorage 기반 기기 UUID 관리 |

### 훅
| 파일 | 역할 |
|------|------|
| `src/hooks/useCollabTournament.js` | 팀장용: 대회 생성, 조 편성, 실시간 상태 감시, 검증 실행 |
| `src/hooks/useCollabParticipant.js` | 참여자용: 코드로 대회 참여, 조 선택, 점수 제출, 상태 수신 |
| `src/hooks/useCollabVerification.js` | 두 제출 비교 로직 (순수 함수) |

### 컴포넌트 (`src/components/collab/`)
| 파일 | 역할 |
|------|------|
| `CollabModeSelect.jsx` | 앱 시작 화면: 혼자입력/협동입력 버튼 |
| `CollabRoleSelect.jsx` | 팀장/참여자 선택 |
| `CollabLeaderSetup.jsx` | 대회 생성 + 코드 발급 + 파 설정 + 조 편성 (다단계 폼) |
| `CollabLeaderDashboard.jsx` | 실시간 입력 현황판 (조별 제출/검증 상태) |
| `CollabJoinScreen.jsx` | 코드 입력 + 닉네임 입력 → 대회 진입 |
| `CollabGroupSelect.jsx` | 조 선택 화면 (제출 상태 표시) |
| `CollabScoreCard.jsx` | 모바일 최적화 스코어카드 입력 UI |
| `CollabSubmissionStatus.jsx` | 제출 후 상태 (대기/승인/충돌+상세내역) |

---

## 5. 수정 대상 기존 파일

### `src/App.jsx`
- `screenMode`에 신규 값 추가: `'mode-select'`, `'collab-role'`, `'collab-leader-setup'`, `'collab-leader-dashboard'`, `'collab-join'`, `'collab-group-select'`, `'collab-scorecard'`, `'collab-submission-status'`
- 앱 시작 시 `'mode-select'` 화면으로 진입 (기존 `'list'` 대신)
- collab 관련 state 추가: `collabTournamentId`, `collabGroupNumber`, `collabNickname`
- 신규 컴포넌트 import 및 렌더링 분기
- 협동모드에서 `'summary'` 전환 시 변환된 tournament 객체를 SummaryPage에 전달
- **기존 혼자입력 로직은 전혀 수정하지 않음**

### `package.json`
- `firebase` 의존성 추가

### `.gitignore`
- `.env` 추가 확인

---

## 6. 팀장 플로우 상세

### Step 1: 대회 생성
- 대회명, 날짜, 홀 수(18/36) 입력
- 생성 시 6자리 고유 코드 발급 (Firestore에서 중복 체크)
- 코드는 복사/공유 가능하도록 UI 제공

### Step 2: 파 설정
- 코스별 탭 (A, B, C, D)
- 각 코스에 9개 홀의 파 값 입력 (기본값 4)
- 코스 합계 파 자동 계산 표시

### Step 3: 클럽/선수 등록 및 조 편성
- **기존 ClubManagement/ClubMemberList UI 패턴을 재사용**하되 데이터는 Firestore에 저장
- 기존 `useClubs`, `useMembers` 훅 참고: `src/hooks/useClubs.js`, `src/hooks/useMembers.js`
- 조 편성은 기존 ScoreTable.jsx의 조 구조와 동일:
  - `src/utils/data.js`의 `createInitialPlayers()` 로직 재사용
  - 36홀: 36개 조 (A-1 ~ D-9), 각 조 기본 4명
  - 18홀: 18개 조 (A-1 ~ B-9), 각 조 기본 4명
  - 추가 선수: "A-1-1" 형태 (기존 `addPlayerToCourse()` 로직 재사용)
- 각 조에 선수 이름/성별/클럽 배정
- 기존 IndexedDB의 회원 데이터로 자동완성 (기존 `searchByName()` 재사용)

### Step 4: 대회 활성화 → 실시간 대시보드
- status를 'active'로 변경하면 참여자가 입력 가능
- 대시보드에서 전체 조의 상태를 실시간 모니터링:
  - 미제출 (0/2) → 회색
  - 1명 제출 (1/2) → 노란색
  - 검증 완료 (2/2 일치) → 초록색
  - 충돌 (불일치) → 빨간색
- 모든 조가 검증 완료되면 "결과 보기" 버튼 활성화

### 결과 변환
- `getVerifiedResults()` 함수로 Firestore 데이터를 기존 tournament 객체 형태로 변환
- 변환 대상: `src/utils/data.js`의 player 구조 (id, group, course, name, gender, club, scoreA~D, detailScores)
- 변환된 객체를 기존 `SummaryPage.jsx`에 그대로 전달 → 기존 랭킹/탭 UI 재사용

---

## 7. 참여자 플로우 상세

### Step 1: 코드 입력
- 6자리 코드 + 닉네임 입력
- Firestore에서 코드로 대회 검색 (`where('code', '==', inputCode)`)
- 매칭 실패 → "대회를 찾을 수 없습니다" 에러
- 매칭 성공 → 대회명 표시, 확인 후 진입

### Step 2: 조 선택
- 전체 조 목록을 그리드로 표시
- 각 조의 제출 상태 표시 (0/2, 1/2, 검증완료, 충돌)
- 이미 본인이 제출한 조는 별도 표시
- 조 클릭 → 해당 조의 선수 목록 확인 후 스코어카드 진입

### Step 3: 스코어카드 입력 (핵심 UI)
- **모바일 최적화 UI** (아래 섹션 8 참조)
- 해당 조의 모든 선수에 대해 A1~D9 홀별 점수 입력
- A, B, C, D 코스 합계는 자동 계산
- 모든 홀이 채워져야 제출 버튼 활성화

### Step 4: 제출 후 상태
- 제출 완료 → Firestore의 group 문서에 submission 추가
- 대기 중 (1/2): "다른 참여자의 입력을 기다리는 중..."
- 일치 (2/2): "검증 완료! 기록이 승인되었습니다."
- 충돌: 불일치 홀 목록 표시 + "다시 입력하기" 버튼
  - 충돌 시 두 제출 모두 초기화, 두 참여자 모두 재입력

---

## 8. 스코어카드 모바일 UI 설계

### 레이아웃 구조
```
┌────────────────────────────────┐
│ ← 뒤로   [3조] 점수 입력       │ 상단 고정
├────────────────────────────────┤
│ [A코스] [B코스] [C코스] [D코스] │ 탭 고정
├────────────────────────────────┤
│ 파: 4  3  5  4  3  4  5  3  4  │ 파 행
├────────────────────────────────┤
│ ┌─ 김민수 (남, 방배) ─────────┐│
│ │ 1: [_]  2: [_]  3: [_]     ││ 3열 그리드
│ │ 4: [_]  5: [_]  6: [_]     ││
│ │ 7: [_]  8: [_]  9: [_]     ││
│ │ A코스 합계: --              ││
│ └─────────────────────────────┘│
│ ┌─ 이영희 (여, 양재) ─────────┐│
│ │ ...                         ││
│ └─────────────────────────────┘│
├────────────────────────────────┤
│ 미입력: 12홀   [제출하기]       │ 하단 고정
└────────────────────────────────┘
```

### 입력 방식
- 각 홀: 숫자 input (type="number", min=1, max=12)
- 터치 친화적: 최소 44px 터치 타겟
- 미입력 홀 빨간 테두리, 입력 완료 홀 초록 배경
- 충돌 재입력 시: 불일치 홀 노란 배경 + 이전 두 값 표시

---

## 9. 2인 교차검증 시스템

### 비교 로직 (`useCollabVerification.js`)
```
입력: submission1, submission2 (두 참여자의 점수 데이터)
비교: 모든 선수의 모든 홀(A1~D9) 점수를 하나씩 비교
출력: { isMatch: boolean, discrepancies: [...] }
```

### 검증 트리거
- Firestore onSnapshot으로 group 문서 감시
- `Object.keys(submissions).length >= 2` 감지 시 비교 실행
- **팀장 클라이언트**가 비교 후 결과를 group 문서에 기록
- **참여자 클라이언트**도 동일 로직 실행 (팀장 오프라인 시 대비)
- Firestore 트랜잭션으로 중복 쓰기 방지

### 충돌 처리
- 불일치 발견 → `verificationStatus: 'conflict'` + `discrepancies` 배열 기록
- 두 참여자 모두 onSnapshot으로 충돌 알림 수신
- 충돌 시 submissions 초기화 → 두 참여자 모두 재입력 필요
- 재입력 시 불일치 홀을 노란색으로 강조 표시

---

## 10. 기기 식별

### `src/utils/deviceId.js`
- `crypto.randomUUID()`로 고유 UUID 생성
- `localStorage('parkgolf-device-id')`에 저장
- 별도 로그인/회원가입 없이 기기 UUID + 닉네임으로 참여자 구분

---

## 11. 기존 코드 재사용 목록

| 재사용 대상 | 파일 | 용도 |
|-------------|------|------|
| `createInitialPlayers()` | `src/utils/data.js` | 조 편성 초기 데이터 생성 |
| `addPlayerToCourse()` | `src/utils/data.js` | 추가 선수 로직 |
| `searchByName()` | `src/hooks/useMembers.js` | 선수 이름 자동완성 |
| `SummaryPage` + 4개 탭 | `src/components/summary/` | 최종 결과 표시 |
| `useRanking` + `ranking.js` | `src/hooks/useRanking.js`, `src/utils/ranking.js` | 순위 계산 |
| 클럽 관리 UI 패턴 | `src/components/club/` | 대회별 클럽/선수 등록 UI 참고 |

---

## 12. 구현 순서

### Phase 1: 인프라 (Firebase + 유틸리티)
1. `firebase` 패키지 설치
2. Firebase 프로젝트 생성 및 Firestore 활성화
3. `src/utils/firebase.js` - Firebase 초기화
4. `src/utils/deviceId.js` - 기기 UUID
5. `src/utils/tournamentCode.js` - 코드 생성
6. `src/utils/firestoreOps.js` - CRUD 함수 (대회 생성/조회부터)
7. `.env.example`, `.gitignore` 업데이트

### Phase 2: 모드 선택 + 역할 선택
1. `CollabModeSelect.jsx` - 혼자입력/협동입력 선택
2. `CollabRoleSelect.jsx` - 팀장/참여자 선택
3. `App.jsx` 수정 - 시작 화면을 mode-select로, 신규 라우팅 추가

### Phase 3: 팀장 - 대회 생성/설정
1. `useCollabTournament.js` - 대회 생성, 파 설정, 조 편성
2. `CollabLeaderSetup.jsx` - 다단계 폼 (대회정보 → 파 설정 → 클럽/선수/조 편성)
3. `firestoreOps.js` 확장 - 조 초기화, 선수 배정

### Phase 4: 참여자 - 코드 진입 + 조 선택
1. `useCollabParticipant.js` - 코드 검색, 대회 참여, 실시간 감시
2. `CollabJoinScreen.jsx` - 코드/닉네임 입력
3. `CollabGroupSelect.jsx` - 조 선택 그리드

### Phase 5: 스코어카드 UI
1. `CollabScoreCard.jsx` - 모바일 최적화 홀별 입력
2. 자동 합계 계산, 입력 validation
3. 제출 → Firestore에 submission 저장

### Phase 6: 검증 시스템
1. `useCollabVerification.js` - 비교 로직
2. `CollabSubmissionStatus.jsx` - 제출 후 상태 표시
3. 검증 트리거 (팀장/참여자 클라이언트 양쪽)
4. 충돌 시 재입력 플로우

### Phase 7: 팀장 대시보드 + 결과
1. `CollabLeaderDashboard.jsx` - 실시간 조별 상태
2. `getVerifiedResults()` - Firestore → 기존 tournament 형태 변환
3. 기존 SummaryPage 연동

### Phase 8: 마무리
1. 네트워크 에러 처리 (협동모드는 온라인 필수 안내)
2. 로딩/에러 상태 UI
3. 엣지 케이스 (동일 기기 중복 제출, 브라우저 새로고침 등)

---

## 13. 검증 방법

1. **Firebase 연결 테스트**: `npm run dev` → 콘솔에서 Firestore 연결 확인
2. **팀장 플로우**: 대회 생성 → 코드 발급 → 파 설정 → 조 편성 → 대시보드 확인
3. **참여자 플로우**: 다른 브라우저/시크릿 탭에서 코드 입력 → 대회 진입 → 조 선택 → 스코어 입력 → 제출
4. **2인 검증**: 두 개 브라우저에서 같은 조에 점수 입력 → 일치 시 승인 확인 / 불일치 시 충돌 알림 확인
5. **결과 확인**: 팀장 대시보드 → "결과 보기" → 기존 SummaryPage에서 랭킹/탭 정상 표시 확인
6. **기존 기능 회귀**: 혼자입력모드가 여전히 정상 동작하는지 확인
